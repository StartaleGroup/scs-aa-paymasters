// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.29;

import {Script, console} from "forge-std/Script.sol";
import {IOracleHelper} from "../src/interfaces/IOracleHelper.sol";
import {IOracle} from "../src/interfaces/IOracle.sol";
import "../src/deployer/Deployer.sol";

contract DeployTokenPaymasterMinatoCreate3 is Script {
    Deployer deployerInstance;
    address entryPoint;
    mapping(uint256 => uint256) public DEPLOYMENT_CHAIN_GAS_PRICES;

    function setUp() public {
        deployerInstance = Deployer(vm.envAddress("DEPLOYER_CONTRACT_ADDRESS")); // Set Deployer contract
        // EntryPoint v0.7 address
        entryPoint = vm.parseAddress("0x0000000071727De22E5E9d8BAf0edAc6f37da032");
        DEPLOYMENT_CHAIN_GAS_PRICES[1946] = 0.002 gwei;
    }

    function run() public {
        uint256 deployerPrivateKey = vm.envUint("DEPLOYER_CONTRACT_DEPLOYER_PRIVATE_KEY");

        string memory contractName = "StartaleTokenPaymaster";
        string memory saltString = "TOKEN_PAYMASTER_V_1_0_0_SALT_200525_cPzqgG8"; // placeholder until salt is final, then get it from env
        // for above salt the address would be 0x0000d23edaadfcca8e8eefd421b237ee6a24931c

        // Review
        bytes memory deployedBytecode =
            hex"60a06040523461014f576139db803803809161001a82610167565b60a0396101808160a001911261014f576100326101f2565b61003c60c06101ff565b60e0516001600160401b03811161014f578361005a9160a001610221565b6100656101006101ff565b610120516100746101406101ff565b61007f6101606101ff565b9061008b610180610288565b926100976101a061029b565b6101c0519095906001600160401b03811161014f578a6100b99160a001610221565b6101e0519097906001600160401b03811161014f578b6100db9160a0016102a9565b610200519099906001600160401b03811161014f576101069c6101009160a00161030e565b9a6103c6565b604051612dfd9081610bde8239608051818181610510015281816105f7015281816106d20152818161085f01528181610975015281816113e80152818161170c01526122070152f35b5f80fd5b634e487b7160e01b5f52604160045260245ffd5b60a0601f91909101601f19168101906001600160401b0382119082101761018d57604052565b610153565b604081019081106001600160401b0382111761018d57604052565b601f909101601f19168101906001600160401b0382119082101761018d57604052565b604051906101df6040836101ad565b565b6001600160a01b0381160361014f57565b60a051906101df826101e1565b51906101df826101e1565b6001600160401b03811161018d5760051b60200190565b9080601f8301121561014f5781516102388161020a565b9261024660405194856101ad565b81845260208085019260051b82010192831161014f57602001905b82821061026e5750505090565b60208091835161027d816101e1565b815201910190610261565b519065ffffffffffff8216820361014f57565b519060ff8216820361014f57565b9080601f8301121561014f5781516102c08161020a565b926102ce60405194856101ad565b81845260208085019260051b82010192831161014f57602001905b8282106102f65750505090565b6020809161030384610288565b8152019101906102e9565b81601f8201121561014f578051906103258261020a565b9261033360405194856101ad565b82845260208085019360061b8301019181831161014f57602001925b82841061035d575050505090565b60408483031261014f576020604091825161037781610192565b8651610382816101e1565b815261038f838801610288565b8382015281520193019261034f565b80518210156103b25760209160051b010190565b634e487b7160e01b5f52603260045260245ffd5b93979661040b968a926103fc8e9d9f9e95969a6103f26103e46101d0565b65ffffffffffff9096168652565b60ff166020850152565b6001600160a01b031696610590565b82518651811490811591610562575b50610553576001600160a01b03811690811561054457600580546001600160a01b0319166001600160a01b03909216919091179055604051905f7fccde24da5797c4d64f7ad2aedd15db412e2d301f426be8da35b1e251321eec6e8180a3620249f0821161053557806104c0836104b17f33ddf610723ec48e858790576fb3294cc312fcbd937c1475d53e3673145488eb95600655565b5f835260208301526040820190565b0390a15f5b815181101561051e57806105186104ee6104e16001948661039e565b516001600160a01b031690565b6105076104fb848a61039e565b5165ffffffffffff1690565b610511848861039e565b51916108c3565b016104c5565b50505090506101df600160ff196008541617600855565b63313db2a560e11b5f5260045ffd5b6328a57c6f60e21b5f5260045ffd5b63512509d360e11b5f5260045ffd5b9050845114155f61041a565b9081602091031261014f576105829061029b565b90565b6040513d5f823e3d90fd5b92956105a09294989791956106b9565b835186510361055357600180546001600160a01b039283166001600160a01b03199182161790915560028054949092169316929092179091556105e2906109da565b600154600490602090610605906001600160a01b03165b6001600160a01b031690565b60405163313ce56760e01b815292839182905afa80156106b45761064a915f91610685575b506002805460ff60a01b191660a09290921b60ff60a01b16919091179055565b5f5b815181101561067f57806106796106686104e16001948661039e565b610672838861039e565b5190610a9c565b0161064c565b50509050565b6106a7915060203d6020116106ad575b61069f81836101ad565b81019061056e565b5f61062a565b503d610695565b610585565b916106c3916107ab565b8051801561079c575f5b8181106106d957505050565b6106e96105f96104e1838661039e565b1561078d576107046106fe6104e1838661039e565b3b151590565b61077e578061074461073761071e6104e16001958861039e565b6001600160a01b03165f90815260208190526040902090565b805460ff19166001179055565b6107546105f96104e1838761039e565b7f47d1c22a25bb3a5d4e481b9b1e6944c2eade3181a0a20b495ed61d35b5323f245f80a2016106cd565b6319e573cb60e11b5f5260045ffd5b63c943590960e01b5f5260045ffd5b63b5fa16ed60e01b5f5260045ffd5b8060601b15610870576001600160a01b0316638b78c6d8198190555f7f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08180a36040516301ffc9a760e01b815263122a0e9b60e31b60048201526020816024816001600160a01b0386165afa80156106b4575f90610833575b61082e9150610b32565b608052565b506020813d602011610868575b8161084d602093836101ad565b8101031261014f5751801515810361014f5761082e90610824565b3d9150610840565b637448fbae5f526004601cfd5b9060206108bf9165ffffffffffff81511665ffffffffffff198554161784550151151582549066ff0000000000009060301b169066ff00000000000019161790565b9055565b6001600160a01b03811692909183156109cb57621e848065ffffffffffff8216116109bc576001600160a01b0383165f9081526009602052604090205460301c60ff166109ad5761096e827f064ffbbbb47c17889eb51257d47e705f5f589c62458218b8322978262bb89e849461096961093b6101d0565b65ffffffffffff86168152600160208201526001600160a01b0383165f90815260096020526040902061087d565b610b7e565b6109a86040519283928365ffffffffffff918216815282516001600160a01b03166020808301919091529092015116604082015260600190565b0390a2565b63c78e82ad60e01b5f5260045ffd5b631211a89f60e21b5f5260045ffd5b630f58058360e11b5f5260045ffd5b65ffffffffffff8151168015908115610a8f575b50610a81578065ffffffffffff7f93763050325d1d84aaf84b5fe9bff2caf268131a8384844c169b2cadad99b1de92511665ffffffffffff196003541617600355610a5a60ff6020830151166003549066ff0000000000009060301b169066ff00000000000019161790565b60035560408051825165ffffffffffff16815260209283015160ff169281019290925290a1565b62acf6ab60e01b5f5260045ffd5b6202a3009150115f6109ee565b81516001600160a01b031615610b235765ffffffffffff6020830151168015908115610b16575b50610a81576001600160a01b039081165f9081526004602090815260409091208351815494909201516001600160d01b0319909416919092161760a09290921b65ffffffffffff60a01b16919091179055565b6202a3009150115f610ac3565b635521068160e01b5f5260045ffd5b15610b3957565b60405162461bcd60e51b815260206004820152601e60248201527f49456e747279506f696e7420696e74657266616365206d69736d6174636800006044820152606490fd5b60407f24e1353e7ce7278b88d4d6dcfc29992d0e138c0ab47d793b173bb8318fe99e2491610bac8482610a9c565b815184516001600160a01b0316815260209485015165ffffffffffff16948101949094526001600160a01b031692a256fe60806040526004361015610011575f80fd5b5f5f3560e01c80621066b6146118dc5780622524bc146117925780630396cb60146116dc5780630ae9abe31461168b5780630e316ab7146115ec5780631b9a91a4146114f95780631c39ac1c14611465578063205c2878146113bb5780632075945e146111f357806325692962146111a85780634031c20e1461116b57806344004cc11461105f578063442c188c1461103c57806352b7512c14610fb757806352f5a39c14610e7957806354d1f13d14610e3357806359b1474414610d8f578063715018a614610d53578063736c0d5b14610a6657806373acf54214610ccf57806375151b6314610c8f5780637631919014610bf75780637c627b2114610ba15780637dd345cb14610aa25780637df73e2714610a665780638da5cb5b14610a3b578063a5eb3cdb146109de578063a6e12780146109b7578063ab94cad714610999578063b0d691fe14610955578063ba912750146108c4578063bb9fe6bf1461083b578063bcf44cfb14610772578063c15ef47a1461074b578063c23a5cea146106a5578063c389c9b414610674578063c399ec88146105c2578063c992f6561461059b578063d0e30db0146104f9578063eb12d61e146103fa578063ebf351001461037e578063efb7601d14610352578063f0130df214610312578063f04e283e1461028d578063f2fde38b146102475763fee81cf414610212575f80fd5b346102445760203660031901126102445761022b611980565b9063389a75e1600c5252602080600c2054604051908152f35b80fd5b5060203660031901126102445760049061025f611980565b50610268611f83565b7feb0149e8000000000000000000000000000000000000000000000000000000008152fd5b506020366003190112610244576102a2611980565b6102aa611f83565b63389a75e1600c528082526020600c20805442116103055790826001600160a01b0392551680638b78c6d819547f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08480a3638b78c6d8195580f35b636f5e881883526004601cfd5b50346102445760203660031901126102445765ffffffffffff60406020926001600160a01b03610340611980565b16815260098452205416604051908152f35b5034610244576020366003190112610244576020610376610371611980565b611cde565b604051908152f35b5034610244576020366003190112610244576004358015158091036103f6576103a5611f83565b6008548160ff82161515036103b8578280f35b60ff191660ff8216176008556040519081527f48dae7fcb9afca38553f807930c45547fb1cdd01581ba9156dd2d39f38f3caf390602090a15f808280f35b5080fd5b5060203660031901126102445761040f611980565b610417611f83565b6001600160a01b038116908183528260205260ff6040842054166104cd5781156104a5573b61047d578082528160205260408220600160ff198254161790557f47d1c22a25bb3a5d4e481b9b1e6944c2eade3181a0a20b495ed61d35b5323f248280a280f35b6004827f33cae796000000000000000000000000000000000000000000000000000000008152fd5b6004837fc9435909000000000000000000000000000000000000000000000000000000008152fd5b602483837f9fb0d64c000000000000000000000000000000000000000000000000000000008252600452fd5b508060031936011261024457806001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016803b156105985781602491604051928380927fb760faf900000000000000000000000000000000000000000000000000000000825230600483015234905af1801561058d5761057c5750f35b8161058691611a1d565b6102445780f35b6040513d84823e3d90fd5b50fd5b503461024457806003193601126102445760206001600160a01b0360055416604051908152f35b5034610244578060031936011261024457604051906370a0823160e01b82523060048301526020826024816001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000165afa9081156106685790610631575b602090604051908152f35b506020813d602011610660575b8161064b60209383611a1d565b8101031261065c5760209051610626565b5f80fd5b3d915061063e565b604051903d90823e3d90fd5b5034610244578060031936011261024457604060035460ff82519165ffffffffffff8116835260301c166020820152f35b503461024457602036600319011261024457806106c0611980565b6106c8611f83565b6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001690813b15610747576001600160a01b03602484928360405195869485937fc23a5cea0000000000000000000000000000000000000000000000000000000085521660048401525af1801561058d5761057c5750f35b5050fd5b503461024457806003193601126102445760206001600160a01b0360025416604051908152f35b50346102445760403660031901126102445761078c611980565b6001600160a01b0361079c611996565b916107a5611f83565b1690818352600960205260ff604084205460301c16156108285765ffffffffffff16621e848081116108195760207f35e459692f13ac64112f3d2d121ddd0f90cfe52d8f3f900ee48b279c774b701f9183855260098252604085208165ffffffffffff19825416179055604051908152a280f35b600483631211a89f60e21b8152fd5b602483836306439c6b60e01b8252600452fd5b5034610244578060031936011261024457610854611f83565b806001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016803b15610598578180916004604051809481937fbb9fe6bf0000000000000000000000000000000000000000000000000000000083525af1801561058d5761057c5750f35b50346102445760c03660031901126102445760043567ffffffffffffffff81116103f65761012060031982360301126103f6576108ff611996565b60443565ffffffffffff8116810361095157606435916001600160a01b038316830361094d5760a4359465ffffffffffff861686036102445760206103768760843587878760048c01611afc565b8480fd5b8380fd5b503461024457806003193601126102445760206040516001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000168152f35b50346102445780600319360112610244576020600654604051908152f35b503461024457806003193601126102445760206001600160a01b0360015416604051908152f35b5034610244576040366003190112610244576109f8611f83565b604051610a04816119ed565b60043565ffffffffffff81168103610a375781526024359060ff82168203610a3757610a349160208201526120ee565b80f35b8280fd5b50346102445780600319360112610244576020638b78c6d819546001600160a01b0360405191168152f35b50346102445760203660031901126102445760ff60406020926001600160a01b03610a8f611980565b1681528084522054166040519015158152f35b50346102445760403660031901126102445760043567ffffffffffffffff81116103f657366023820112156103f657806004013567ffffffffffffffff8111610a37576024820191602436918360051b010111610a37576024359081151580920361095157610b0f611f83565b60ff821692845b828110610b21578580f35b806001600160a01b03610b3f610b3a6001948787611a5b565b611a7f565b1687526007602052604087208660ff198254161790557f8ff8c5211f68ef53b4bdd15ab2ea6d87be8a3dbf58865bd8325c984057e4fcb46040610b86610b3a848888611a5b565b6001600160a01b03825191168152876020820152a101610b16565b503461024457608036600319011261024457600360043510156102445760243567ffffffffffffffff81116103f657610be1610a349136906004016119bf565b90610bea6121fd565b6064359160443591612a8f565b5034610244576020366003190112610244576001600160a01b03610c19611980565b610c21611f83565b16808252600960205260ff604083205460301c1615610c7d57808252600960205281604081205580825260046020528160408120557f4c910b69fe65a61f7531b9c5042b2329ca7179c77290aa7e2eb3afa3c8511fd38280a280f35b6306439c6b60e01b8252600452602490fd5b50346102445760203660031901126102445760ff60406020926001600160a01b03610cb8611980565b16815260098452205460301c166040519015158152f35b50602036600319011261024457600435610ce7611f83565b620249f08111610d2b5760407f33ddf610723ec48e858790576fb3294cc312fcbd937c1475d53e3673145488eb91600654908060065582519182526020820152a180f35b6004827f627b654a000000000000000000000000000000000000000000000000000000008152fd5b508060031936011261024457600490610d6a611f83565b7f0e98a7a2000000000000000000000000000000000000000000000000000000008152fd5b506020366003190112610244576001600160a01b03610dac611980565b610db4611f83565b168015610e0b576001600160a01b036005548273ffffffffffffffffffffffffffffffffffffffff19821617600555167fccde24da5797c4d64f7ad2aedd15db412e2d301f426be8da35b1e251321eec6e8380a380f35b6004827fa295f1bc000000000000000000000000000000000000000000000000000000008152fd5b50806003193601126102445763389a75e1600c52338152806020600c2055337ffa7b8eab7da67f412cc9575ed43464468f9bfbae89d1675917346ca6d8fe3c928280a280f35b50346102445760203660031901126102445760043567ffffffffffffffff81116103f657610eab9036906004016119bf565b91610eb683836129f5565b9390916002811015610fa357610f945784602411610a3757601481013594603411610a37576024013592610ee991612a2c565b969597928795999291946040519a65ffffffffffff8c9b168b5265ffffffffffff1660208b01526001600160a01b031660408a0152606089015265ffffffffffff16608088015260801c6fffffffffffffffffffffffffffffffff1660a087015260801c6fffffffffffffffffffffffffffffffff1660c086015260e085016101009052816101008601526101208501378183016101200152601f1990601f01168101036101200190f35b60048363817c70e760e01b8152fd5b602484634e487b7160e01b81526021600452fd5b50346102445760603660031901126102445760043567ffffffffffffffff81116103f65761012060031982360301126103f6576020611006606092610ffa6121fd565b6044359060040161229a565b604092919251948593604085528051938491826040880152018686015e8383018501526020830152601f01601f19168101030190f35b5034610244578060031936011261024457602060ff600854166040519015158152f35b5034610244576060366003190112610244576004356001600160a01b0381168091036103f657602435906001600160a01b0382169081830361095157604435926110a7611f83565b6110af612189565b821561115c57601452826034526fa9059cbb00000000000000000000000084526020846044601082855af1806001865114161561113e575b50836034526040519283527fedf7bea45e16025d7f82902171a24376f5f3a2c06d9d8c2be4d41bbc7292f74a60203394a4807f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f005d80f35b3d823b1517101561114f575f6110e7565b6390b8ec1884526004601cfd5b600485634261081360e11b8152fd5b50346102445760203660031901126102445760ff60406020926001600160a01b03611194611980565b168152600784522054166040519015158152f35b50806003193601126102445763389a75e1600c523381526202a30042016020600c2055337fdbf36a107da19e49527a7176a1babf963b4b0ff8cde35ee35d6cd8f1f9ac7e1d8280a280f35b50346102445760803660031901126102445761120d611980565b611215611996565b906040366043190112610a375761122a611f83565b604051611236816119ed565b6044356001600160a01b038116810361094d57815260643565ffffffffffff8116810361094d5760208201526001600160a01b0382169283156113935765ffffffffffff1691621e8480831161138457838552600960205260ff604086205460301c1661135c57916113588261132d6060947f064ffbbbb47c17889eb51257d47e705f5f589c62458218b8322978262bb89e8496898965ffffffffffff8060408051946112e2866119ed565b8b865260208601946001865281526009602052209351161665ffffffffffff1983541617825551151566ff00000000000082549160301b169066ff0000000000001916179055611f9f565b604051928352602083019065ffffffffffff602080926001600160a01b038151168552015116910152565ba280f35b6004857fc78e82ad000000000000000000000000000000000000000000000000000000008152fd5b600485631211a89f60e21b8152fd5b6004857f1eb00b06000000000000000000000000000000000000000000000000000000008152fd5b503461024457604036600319011261024457806113d6611980565b6113de611f83565b6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001690813b15610747576001600160a01b03604484928360405195869485937f205c287800000000000000000000000000000000000000000000000000000000855216600484015260243560248401525af1801561058d5761057c5750f35b503461024457602036600319011261024457604080916001600160a01b0361148b611980565b8260208551611499816119ed565b828152015216815260046020522065ffffffffffff8251916114ba836119ed565b546001600160a01b038116835260a01c1660208201526114f78251809265ffffffffffff602080926001600160a01b038151168552015116910152565bf35b5060403660031901126102445761150e611980565b6001600160a01b0360243591611522611f83565b61152a612189565b1680156115dd578280808085855af13d156115d8573d61154981611a3f565b906115576040519283611a1d565b81528460203d92013e5b156115b0577f8455ae6be5d92f1df1c3c1484388e247a36c7e60d72055ae216dbc258f257d4b8380a3807f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f005d80f35b6004837f27fcd9d1000000000000000000000000000000000000000000000000000000008152fd5b611561565b600483634261081360e11b8152fd5b506020366003190112610244576001600160a01b03611609611980565b611611611f83565b168082528160205260ff6040832054161561166057808252816020526040822060ff1981541690557f3525e22824a8a7df2c9a6029941c824cf95b6447f1e13d5128fd3826d35afe8b8280a280f35b7f2ac468fb000000000000000000000000000000000000000000000000000000008252600452602490fd5b503461024457602036600319011261024457604080916001600160a01b036116b1611980565b1681526004602052205465ffffffffffff8251916001600160a01b038116835260a01c166020820152f35b50602036600319011261065c5760043563ffffffff811680910361065c57611702611f83565b6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001690813b1561065c575f906024604051809481937f0396cb60000000000000000000000000000000000000000000000000000000008352600483015234905af1801561178757611779575080f35b61178591505f90611a1d565b005b6040513d5f823e3d90fd5b3461065c57606036600319011261065c576117ab611980565b6117b3611996565b6044359160ff831680930361065c576001600160a01b03906117d3611f83565b16918273ffffffffffffffffffffffffffffffffffffffff19600154161760015560405163313ce56760e01b8152602081600481875afa90811561178757611785947f8fc6315ba94359fb67e8182b2c063eeb20ced644701b057dce2d628ee0c8f890926020925f916118af575b507fffffffffffffffffffffff00ffffffffffffffffffffffffffffffffffffffff74ff00000000000000000000000000000000000000006002549260a01b16911617600255604051908152a165ffffffffffff604051926118a2846119ed565b16825260208201526120ee565b6118cf9150833d85116118d5575b6118c78183611a1d565b810190611c02565b87611841565b503d6118bd565b3461065c57606036600319011261065c576118f5611980565b604036602319011261065c57611909611f83565b6001600160a01b038116805f52600960205260ff60405f205460301c161561196e5750604051611938816119ed565b6024356001600160a01b038116810361065c5781526044359165ffffffffffff8316830361065c57611785926020830152611f9f565b6306439c6b60e01b5f5260045260245ffd5b600435906001600160a01b038216820361065c57565b6024359065ffffffffffff8216820361065c57565b35906001600160a01b038216820361065c57565b9181601f8401121561065c5782359167ffffffffffffffff831161065c576020838186019501011161065c57565b6040810190811067ffffffffffffffff821117611a0957604052565b634e487b7160e01b5f52604160045260245ffd5b90601f8019910116810190811067ffffffffffffffff821117611a0957604052565b67ffffffffffffffff8111611a0957601f01601f191660200190565b9190811015611a6b5760051b0190565b634e487b7160e01b5f52603260045260245ffd5b356001600160a01b038116810361065c5790565b903590601e198136030182121561065c570180359067ffffffffffffffff821161065c5760200191813603831361065c57565b929192611ad282611a3f565b91611ae06040519384611a1d565b82948184528183011161065c578281602093845f960137010152565b939194929094611b19611b126040870187611a93565b3691611ac6565b6020815191012095611b31611b126060880188611a93565b6020815191012095611b4660e0820182611a93565b60341161065c576014013560405197602089019983356001600160a01b03168b52602084013560408b015260608a01526080890152608082013560a089015260c088015260a081013560e088015260c00135610100870152466101208701523061014087015265ffffffffffff1661016086015265ffffffffffff166101808501526001600160a01b03166101a08401526101c083015265ffffffffffff166101e08201526101e08152611bfc61020082611a1d565b51902090565b9081602091031261065c575160ff8116810361065c5790565b519069ffffffffffffffffffff8216820361065c57565b908160a091031261065c57611c4681611c1b565b91602082015191604081015191611c64608060608401519301611c1b565b90565b91908203918211611c7457565b634e487b7160e01b5f52601160045260245ffd5b9060ff8091169116039060ff8211611c7457565b60ff16604d8111611c7457600a0a90565b81810292918115918404141715611c7457565b8115611cca570490565b634e487b7160e01b5f52601260045260245ffd5b6001600160a01b0316805f52600460205260405f2060405190611d00826119ed565b54916001600160a01b03831680835265ffffffffffff602084019460a01c16845215611f58579060049160206001600160a01b038351166040519485809263313ce56760e01b82525afa928315611787575f93611f37575b50600254916001600160a01b03831680611e6c575b5060049465ffffffffffff6001600160a01b03611d8f93511691511690612cda565b9260ff611db26001600160a01b036001541665ffffffffffff6003541690612cda565b9360a01c169060ff811682811115611e3c575092611dde611dd9611de49360209596611c88565b611c9c565b90611cad565b915b6040519485809263313ce56760e01b82525afa90811561178757611dde611e1892611c64955f91611e1d575b50611c9c565b611cc0565b611e36915060203d6020116118d5576118c78183611a1d565b5f611e12565b9180919210611e50575b5050602090611de6565b93611dde611dd9611e649360209597611c88565b92905f611e46565b60a060049160405192838092633fabe5a360e21b82525afa908115611787575f905f92611f02575b50611eda57611ea6610e109142611c67565b1115611eb2575f611d6d565b7fd15f73b5000000000000000000000000000000000000000000000000000000005f5260045ffd5b7f032b3d00000000000000000000000000000000000000000000000000000000005f5260045ffd5b9050611f26915060a03d60a011611f30575b611f1e8183611a1d565b810190611c32565b505091505f611e94565b503d611f14565b611f5191935060203d6020116118d5576118c78183611a1d565b915f611d58565b7f8a48ce38000000000000000000000000000000000000000000000000000000005f5260045260245ffd5b638b78c6d819543303611f9257565b6382b429005f526004601cfd5b906001600160a01b03815116156120c657602081019165ffffffffffff83511680159081156120b9575b50612092577f24e1353e7ce7278b88d4d6dcfc29992d0e138c0ab47d793b173bb8318fe99e24916001600160a01b036040921693845f526004602052825f20906001600160a01b0383511673ffffffffffffffffffffffffffffffffffffffff19835416178255517fffffffffffff000000000000ffffffffffffffffffffffffffffffffffffffff65ffffffffffff60a01b83549260a01b16911617905561208f8251809265ffffffffffff602080926001600160a01b038151168552015116910152565ba2565b7eacf6ab000000000000000000000000000000000000000000000000000000005f5260045ffd5b6202a3009150115f611fc9565b7f55210681000000000000000000000000000000000000000000000000000000005f5260045ffd5b65ffffffffffff815116801590811561217c575b506120925760408160ff602065ffffffffffff7f93763050325d1d84aaf84b5fe9bff2caf268131a8384844c169b2cadad99b1de955116928365ffffffffffff19600354161760035501805166ff0000000000006003549160301b169066ff000000000000191617600355835192835251166020820152a1565b6202a3009150115f612102565b7f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f005c6121d55760017f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f005d565b7f3ee5aeb5000000000000000000000000000000000000000000000000000000005f5260045ffd5b6001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016330361222f57565b60646040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601860248201527f43616c6c6572206973206e6f7420456e747279506f696e7400000000000000006044820152fd5b91908201809211611c7457565b9060609160e08101906122b66122b08383611a93565b906129f5565b95919460028610156129e157600160ff8716116129d257600654916122da85612da8565b83116129aa576001600160a01b038535169360808601359661230d6123068960801c60a08a013561228d565b9188611a93565b60241161065c5761234b91612329916014013560801c9061228d565b976fffffffffffffffffffffffffffffffff61234489612da8565b911661228d565b976001810361261d57505060ff600854161580612606575b6125da57601488106125b2578760141161065c573560601c966013190161258a57865f52600960205260ff60405f205460301c1615612577576123dd92916123e36123e892895f52600960205265ffffffffffff60405f2054169586936fffffffffffffffffffffffffffffffff60c08a01351690611cad565b9061228d565b611cad565b90620f4240820191828111611c7457620f423f01918211611c745761240c87611cde565b91821561254b5782620f42406124229204611cad565b61243860ff60035460301c16916123dd83611c9c565b5f198101908111611c745761244f61245592611c9c565b90611cc0565b90604051906370a0823160e01b825260048201526020816024818b5afa908115611787575f91612519575b50106124f1576124ec946124966124de94611a7f565b946040519788966020880194909695919365ffffffffffff936001600160a01b0360a0968160c08a019b16895216602088015260408701526060860152608085015216910152565b03601f198101835282611a1d565b905f90565b7fb223be11000000000000000000000000000000000000000000000000000000005f5260045ffd5b90506020813d602011612543575b8161253460209383611a1d565b8101031261065c57515f612480565b3d9150612527565b877fccffa451000000000000000000000000000000000000000000000000000000005f5260045260245ffd5b866306439c6b60e01b5f5260045260245ffd5b7f9f8bc10c000000000000000000000000000000000000000000000000000000005f5260045ffd5b7f25d8dfa4000000000000000000000000000000000000000000000000000000005f5260045ffd5b7f55d3ab46000000000000000000000000000000000000000000000000000000005f523260045260245ffd5b50325f52600760205260ff60405f20541615612363565b5f9a999193949a9897969598501561263e5763817c70e760e01b5f5260045ffd5b61264791612a2c565b9296939b919790949d87156129755760408414158061296a575b6129425765ffffffffffff891690621e84808211612933576126a1926123dd6123e3926fffffffffffffffffffffffffffffffff60c08f01351690611cad565b620f4240810190818111611c7457620f423f01908111611c745786620f42406126ca9204611cad565b6126e060ff60035460301c16916123dd83611c9c565b5f198101908111611c74578c602461270560209361244f6001600160a01b0396611c9c565b9460405194859384926370a0823160e01b84526004840152165afa908115611787575f91612901575b50106124f15761277e6001600160a01b039361274f888f8e8a918a8e611afc565b6020527b19457468657265756d205369676e6564204d6573736167653a0a33325f52603c600420923691611ac6565b915f926040519260208201918051806040146128c35760411461288d5750505050505b168015612865575f525f60205260ff60405f2054161598895f146128315760ff65ffffffffffff60a01b7fffffffffffff00000000000000000000000000000000000000000000000000006001935b60d01b169360a01b16911617179761281657612812946124966124de94611a7f565b9190565b50505050505060405161282a602082611a1d565b5f81529190565b60ff65ffffffffffff60a01b7fffffffffffff00000000000000000000000000000000000000000000000000005f936127f0565b7f11ec9984000000000000000000000000000000000000000000000000000000005f5260045ffd5b808401515f1a60205260400151835292935090915b5f52516040526020604060805f60015afa505f81523d1851906040526127a1565b507f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff91929394955060400151601b8160ff1c016020521683526128a2565b90506020813d60201161292b575b8161291c60209383611a1d565b8101031261065c57515f61272e565b3d915061290f565b631211a89f60e21b5f5260045ffd5b7ff95eeeac000000000000000000000000000000000000000000000000000000005f5260045ffd5b506041841415612661565b6001600160a01b038d7fb420c372000000000000000000000000000000000000000000000000000000005f521660045260245ffd5b7f0359a00f000000000000000000000000000000000000000000000000000000005f5260045ffd5b63817c70e760e01b5f5260045ffd5b634e487b7160e01b5f52602160045260245ffd5b91603582106125b2578160341015611a6b57603483013560f81c60028110156129e157928260351161065c57603501916034190190565b90604681106125b2578060061161065c57813560d01c92600c821061065c57600683013560d01c926020831061065c57600c81013560601c926040811061065c576020820135928160461161065c57604083013560d01c92604601916045190190565b908160c0919493948101031261065c57612aa8816119ab565b90612ab5602082016119ab565b9260408201359460608301359160a060808501359401359265ffffffffffff8416840361065c576001600160a01b03808716971697612af48385611cc0565b905f906006548382612b0783809761228d565b11612cbe575b5050505f92818111612c88575b5050926123dd65ffffffffffff936123e3612b3894612b419761228d565b92168092611cad565b620f4240810190818111611c7457620f423f01908111611c745782620f4240612b6a9204611cad565b612b8060ff60035460301c16916123dd83611c9c565b5f198101908111611c745761244f612b9792611c9c565b928315612c80576001600160a01b03600554169060405191856060526040526bffffffffffffffffffffffff199060601b16602c526f23b872dd000000000000000000000000600c5260205f6064601c828a5af1908160015f51141615612c73575b5f60605260405215612c3e57916060917f652a3e2ecdaeb77e89486cb74be65c4579b831f00b22f6176aca49f3893827fd9360405192835260208301526040820152a3565b505092507fbc7b62d8000000000000000000000000000000000000000000000000000000005f5260045260245260445260645ffd5b903d873b15171090612bf9565b505050505050565b612c9492959350611c67565b90600a820291808304600a1490151715611c7457926064909104906123dd65ffffffffffff612b1a565b612cd2935090612ccd9161228d565b611c67565b5f8281612b0d565b9060a06001600160a01b0392600460405180958193633fabe5a360e21b8352165afa908115611787575f925f92612d7f575b505f831315612d575765ffffffffffff612d27911642611c67565b11612d2f5790565b7f19abf40e000000000000000000000000000000000000000000000000000000005f5260045ffd5b7fa97b994d000000000000000000000000000000000000000000000000000000005f5260045ffd5b909250612d9b915060a03d60a011611f3057611f1e8183611a1d565b509392505091905f612d0c565b612db69060e0810190611a93565b60341161065c576024013560801c9056fea26469706673582212203fc106d1c601483f239039b98756da0794c6be1aab331ef80a4db39e1adb1d6664736f6c634300081d0033";

        // Load environment variables
        // uint256 salt = vm.envUint("SALT");
        address owner = vm.envAddress("OWNER");
        address feeTreasury = vm.envAddress("TOKEN_FEE_TREASURY");
        uint256 unaccountedGas = vm.envUint("TOKEN_PM_UNACCOUNTED_GAS");
        address nativeAssetToUsdOracle = vm.envAddress("NATIVE_ASSET_TO_USD_ORACLE_MINATO");
        address sequencerUptimeOracle = vm.envAddress("SEQUENCER_UPTIME_ORACLE_MINATO");
        uint48 nativeAssetMaxOracleRoundAge = uint48(vm.envUint("NATIVE_ASSET_MAX_ORACLE_ROUND_AGE"));
        uint8 nativeAssetDecimals = 18;

        // Let's deploy with one Independent Token and more we can add later
        address astrAddress = vm.envAddress("ASTR_TOKEN_ADDERESS_MINATO");
        address astrToUsdOracle = vm.envAddress("ASTR_TO_USD_ORACLE_MINATO");
        uint48 feeMarkupForIndependentToken = uint48(vm.envUint("FEE_MARKUP_FOR_INDEPENDENT_TOKEN"));
        uint48 astrMaxOracleRoundAge = uint48(vm.envUint("ASTR_MAX_ORACLE_ROUND_AGE"));

        // Parse signers from comma-separated string
        string[] memory signers = vm.envString("SIGNERS", ",");
        address[] memory signersAddr = new address[](signers.length);
        for (uint256 i = 0; i < signers.length; i++) {
            signersAddr[i] = vm.parseAddress(signers[i]);
        }

        bytes memory constructorArgs = abi.encode(
            owner,
            entryPoint,
            signersAddr,
            feeTreasury,
            unaccountedGas,
            nativeAssetToUsdOracle,
            sequencerUptimeOracle,
            nativeAssetMaxOracleRoundAge,
            nativeAssetDecimals,
            _toSingletonArray(astrAddress),
            _toSingletonArray(feeMarkupForIndependentToken),
            _toSingletonArray(
                IOracleHelper.TokenOracleConfig({
                    tokenOracle: IOracle(address(astrToUsdOracle)),
                    maxOracleRoundAge: astrMaxOracleRoundAge
                })
            )
        );

        // Concatenate bytecode + constructor arguments
        bytes memory finalBytecode = abi.encodePacked(deployedBytecode, constructorArgs);

        // Deploy contract if needed
        deployGeneric(deployerPrivateKey, saltString, finalBytecode, contractName);
    }

    function deployGeneric(
        uint256 deployerPrivateKey,
        string memory saltString,
        bytes memory finalBytecode,
        string memory contractName
    ) public {
        // Compute derived salt
        bytes32 derivedSalt = keccak256(abi.encodePacked(saltString));

        // Compute contract address before deployment
        address computedAddress = deployerInstance.addressOf(derivedSalt);

        console.log(string(abi.encodePacked(contractName, " Computed Address:")), computedAddress);

        // Check if contract is already deployed
        uint256 codeSize;
        assembly {
            codeSize := extcodesize(computedAddress)
        }

        if (codeSize == 0) {
            console.log(string(abi.encodePacked(contractName, " not deployed, deploying now...")));
            deployContract(deployerPrivateKey, derivedSalt, finalBytecode, contractName, computedAddress);
        } else {
            console.log(string(abi.encodePacked(contractName, " already deployed at:")), computedAddress);
        }
    }

    function deployContract(
        uint256 deployerPrivateKey,
        bytes32 derivedSalt,
        bytes memory finalBytecode,
        string memory contractName,
        address computedAddress
    ) internal {
        uint256 chainId = block.chainid;

        uint256 gasPrice = DEPLOYMENT_CHAIN_GAS_PRICES[chainId];
        require(gasPrice > 0, "No deployment gas price set for this chain");

        console.log("Using gas price:", gasPrice);

        // Deploy contract using deployer's private key
        vm.startBroadcast(deployerPrivateKey);
        (bool success,) = address(deployerInstance).call{gas: 5_000_000}(
            abi.encodeWithSignature("deploy(bytes32,bytes)", derivedSalt, finalBytecode)
        );
        vm.stopBroadcast();

        require(success, "Contract deployment failed");

        console.log(string(abi.encodePacked("Transaction success: ", contractName)));

        // Verify deployment by checking contract existence
        uint256 codeSize;
        assembly {
            codeSize := extcodesize(computedAddress)
        }

        if (codeSize == 0) {
            console.log(string(abi.encodePacked("Invalid deployment of ", contractName)));
        } else {
            console.log(string(abi.encodePacked(contractName, " Deployed Successfully at:")), computedAddress);
        }
    }

    function _toSingletonArray(address addr) internal pure returns (address[] memory) {
        address[] memory array = new address[](1);
        array[0] = addr;
        return array;
    }

    function _toSingletonArray(uint48 element) internal pure returns (uint48[] memory) {
        uint48[] memory array = new uint48[](1);
        array[0] = element;
        return array;
    }

    function _toSingletonArray(IOracleHelper.TokenOracleConfig memory tokenOracleConfig)
        internal
        pure
        returns (IOracleHelper.TokenOracleConfig[] memory)
    {
        IOracleHelper.TokenOracleConfig[] memory array = new IOracleHelper.TokenOracleConfig[](1);
        array[0] = tokenOracleConfig;
        return array;
    }
}
