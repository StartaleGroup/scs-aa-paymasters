// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.30;

import {Script, console} from "forge-std/Script.sol";
import {IOracleHelper} from "../src/interfaces/IOracleHelper.sol";
import {IOracle} from "../src/interfaces/IOracle.sol";
import "../src/deployer/Deployer.sol";

contract DeployTokenPaymasterSoneiumCreate3 is Script {
    Deployer deployerInstance;
    address entryPoint;
    mapping(uint256 => uint256) public DEPLOYMENT_CHAIN_GAS_PRICES;

    function setUp() public {
        deployerInstance = Deployer(vm.envAddress("DEPLOYER_CONTRACT_ADDRESS")); // Set Deployer contract
        // EntryPoint v0.7 address
        entryPoint = vm.parseAddress("0x0000000071727De22E5E9d8BAf0edAc6f37da032");
        DEPLOYMENT_CHAIN_GAS_PRICES[1946] = 0.002 gwei;
        DEPLOYMENT_CHAIN_GAS_PRICES[1868] = 0.001 gwei;
    }

    function run() public {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY"); // or funding account private key

        string memory contractName = "StartaleTokenPaymaster";
        string memory saltString = vm.envString("PROD_TOKEN_PAYMASTER_SALT");

        bytes memory deployedBytecode =
            hex"60a06040523461014f57613a64803803809161001a82610167565b60a0396101808160a001911261014f576100326101f2565b61003c60c06101ff565b60e0516001600160401b03811161014f578361005a9160a001610221565b6100656101006101ff565b610120516100746101406101ff565b61007f6101606101ff565b9061008b610180610288565b926100976101a061029b565b6101c0519095906001600160401b03811161014f578a6100b99160a001610221565b6101e0519097906001600160401b03811161014f578b6100db9160a0016102a9565b610200519099906001600160401b03811161014f576101069c6101009160a00161030e565b9a6103c6565b604051612e869081610bde823960805181818161051b01528181610602015281816106dd0152818161086a01528181610988015281816113fb0152818161171f01526122380152f35b5f80fd5b634e487b7160e01b5f52604160045260245ffd5b60a0601f91909101601f19168101906001600160401b0382119082101761018d57604052565b610153565b604081019081106001600160401b0382111761018d57604052565b601f909101601f19168101906001600160401b0382119082101761018d57604052565b604051906101df6040836101ad565b565b6001600160a01b0381160361014f57565b60a051906101df826101e1565b51906101df826101e1565b6001600160401b03811161018d5760051b60200190565b9080601f8301121561014f5781516102388161020a565b9261024660405194856101ad565b81845260208085019260051b82010192831161014f57602001905b82821061026e5750505090565b60208091835161027d816101e1565b815201910190610261565b519065ffffffffffff8216820361014f57565b519060ff8216820361014f57565b9080601f8301121561014f5781516102c08161020a565b926102ce60405194856101ad565b81845260208085019260051b82010192831161014f57602001905b8282106102f65750505090565b6020809161030384610288565b8152019101906102e9565b81601f8201121561014f578051906103258261020a565b9261033360405194856101ad565b82845260208085019360061b8301019181831161014f57602001925b82841061035d575050505090565b60408483031261014f576020604091825161037781610192565b8651610382816101e1565b815261038f838801610288565b8382015281520193019261034f565b80518210156103b25760209160051b010190565b634e487b7160e01b5f52603260045260245ffd5b93979661040b968a926103fc8e9d9f9e95969a6103f26103e46101d0565b65ffffffffffff9096168652565b60ff166020850152565b6001600160a01b031696610590565b82518651811490811591610562575b50610553576001600160a01b03811690811561054457600580546001600160a01b0319166001600160a01b03909216919091179055604051905f7fccde24da5797c4d64f7ad2aedd15db412e2d301f426be8da35b1e251321eec6e8180a3620249f0821161053557806104c0836104b17f33ddf610723ec48e858790576fb3294cc312fcbd937c1475d53e3673145488eb95600655565b5f835260208301526040820190565b0390a15f5b815181101561051e57806105186104ee6104e16001948661039e565b516001600160a01b031690565b6105076104fb848a61039e565b5165ffffffffffff1690565b610511848861039e565b51916108c3565b016104c5565b50505090506101df600160ff196008541617600855565b63313db2a560e11b5f5260045ffd5b6328a57c6f60e21b5f5260045ffd5b63512509d360e11b5f5260045ffd5b9050845114155f61041a565b9081602091031261014f576105829061029b565b90565b6040513d5f823e3d90fd5b92956105a09294989791956106b9565b835186510361055357600180546001600160a01b039283166001600160a01b03199182161790915560028054949092169316929092179091556105e2906109da565b600154600490602090610605906001600160a01b03165b6001600160a01b031690565b60405163313ce56760e01b815292839182905afa80156106b45761064a915f91610685575b506002805460ff60a01b191660a09290921b60ff60a01b16919091179055565b5f5b815181101561067f57806106796106686104e16001948661039e565b610672838861039e565b5190610a9c565b0161064c565b50509050565b6106a7915060203d6020116106ad575b61069f81836101ad565b81019061056e565b5f61062a565b503d610695565b610585565b916106c3916107ab565b8051801561079c575f5b8181106106d957505050565b6106e96105f96104e1838661039e565b1561078d576107046106fe6104e1838661039e565b3b151590565b61077e578061074461073761071e6104e16001958861039e565b6001600160a01b03165f90815260208190526040902090565b805460ff19166001179055565b6107546105f96104e1838761039e565b7f47d1c22a25bb3a5d4e481b9b1e6944c2eade3181a0a20b495ed61d35b5323f245f80a2016106cd565b6319e573cb60e11b5f5260045ffd5b63c943590960e01b5f5260045ffd5b63b5fa16ed60e01b5f5260045ffd5b8060601b15610870576001600160a01b0316638b78c6d8198190555f7f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08180a36040516301ffc9a760e01b815263122a0e9b60e31b60048201526020816024816001600160a01b0386165afa80156106b4575f90610833575b61082e9150610b32565b608052565b506020813d602011610868575b8161084d602093836101ad565b8101031261014f5751801515810361014f5761082e90610824565b3d9150610840565b637448fbae5f526004601cfd5b9060206108bf9165ffffffffffff81511665ffffffffffff198554161784550151151582549066ff0000000000009060301b169066ff00000000000019161790565b9055565b6001600160a01b03811692909183156109cb57621e848065ffffffffffff8216116109bc576001600160a01b0383165f9081526009602052604090205460301c60ff166109ad5761096e827f064ffbbbb47c17889eb51257d47e705f5f589c62458218b8322978262bb89e849461096961093b6101d0565b65ffffffffffff86168152600160208201526001600160a01b0383165f90815260096020526040902061087d565b610b7e565b6109a86040519283928365ffffffffffff918216815282516001600160a01b03166020808301919091529092015116604082015260600190565b0390a2565b63c78e82ad60e01b5f5260045ffd5b631211a89f60e21b5f5260045ffd5b630f58058360e11b5f5260045ffd5b65ffffffffffff8151168015908115610a8f575b50610a81578065ffffffffffff7f93763050325d1d84aaf84b5fe9bff2caf268131a8384844c169b2cadad99b1de92511665ffffffffffff196003541617600355610a5a60ff6020830151166003549066ff0000000000009060301b169066ff00000000000019161790565b60035560408051825165ffffffffffff16815260209283015160ff169281019290925290a1565b62acf6ab60e01b5f5260045ffd5b6202a3009150115f6109ee565b81516001600160a01b031615610b235765ffffffffffff6020830151168015908115610b16575b50610a81576001600160a01b039081165f9081526004602090815260409091208351815494909201516001600160d01b0319909416919092161760a09290921b65ffffffffffff60a01b16919091179055565b6202a3009150115f610ac3565b635521068160e01b5f5260045ffd5b15610b3957565b60405162461bcd60e51b815260206004820152601e60248201527f49456e747279506f696e7420696e74657266616365206d69736d6174636800006044820152606490fd5b60407f24e1353e7ce7278b88d4d6dcfc29992d0e138c0ab47d793b173bb8318fe99e2491610bac8482610a9c565b815184516001600160a01b0316815260209485015165ffffffffffff16948101949094526001600160a01b031692a256fe60806040526004361015610011575f80fd5b5f5f3560e01c80621066b6146118ef5780622524bc146117a55780630396cb60146116ef5780630ae9abe31461169e5780630e316ab7146115ff5780631b9a91a41461150c5780631c39ac1c14611478578063205c2878146113ce5780632075945e1461120657806325692962146111bb5780634031c20e1461117e57806344004cc114611072578063442c188c1461104f57806352b7512c14610fca57806352f5a39c14610e8c57806354d1f13d14610e4657806359b1474414610da2578063715018a614610d66578063736c0d5b14610a7957806373acf54214610ce257806375151b6314610ca25780637631919014610c0a5780637c627b2114610bb45780637dd345cb14610ab55780637df73e2714610a795780638da5cb5b14610a4e578063a5eb3cdb146109f1578063a6e12780146109ca578063ab94cad7146109ac578063b0d691fe14610968578063ba912750146108cf578063bb9fe6bf14610846578063bcf44cfb1461077d578063c15ef47a14610756578063c23a5cea146106b0578063c389c9b41461067f578063c399ec88146105cd578063c992f656146105a6578063d0e30db014610504578063eb12d61e14610405578063ebf3510014610389578063efb7601d14610352578063f0130df214610312578063f04e283e1461028d578063f2fde38b146102475763fee81cf414610212575f80fd5b346102445760203660031901126102445761022b611993565b9063389a75e1600c5252602080600c2054604051908152f35b80fd5b5060203660031901126102445760049061025f611993565b50610268611fb4565b7feb0149e8000000000000000000000000000000000000000000000000000000008152fd5b506020366003190112610244576102a2611993565b6102aa611fb4565b63389a75e1600c528082526020600c20805442116103055790826001600160a01b0392551680638b78c6d819547f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08480a3638b78c6d8195580f35b636f5e881883526004601cfd5b50346102445760203660031901126102445765ffffffffffff60406020926001600160a01b03610340611993565b16815260098452205416604051908152f35b5034610244576020366003190112610244576060610376610371611993565b611cf1565b9060405192835260208301526040820152f35b503461024457602036600319011261024457600435801515809103610401576103b0611fb4565b6008548160ff82161515036103c3578280f35b60ff191660ff8216176008556040519081527f48dae7fcb9afca38553f807930c45547fb1cdd01581ba9156dd2d39f38f3caf390602090a15f808280f35b5080fd5b5060203660031901126102445761041a611993565b610422611fb4565b6001600160a01b038116908183528260205260ff6040842054166104d85781156104b0573b610488578082528160205260408220600160ff198254161790557f47d1c22a25bb3a5d4e481b9b1e6944c2eade3181a0a20b495ed61d35b5323f248280a280f35b6004827f33cae796000000000000000000000000000000000000000000000000000000008152fd5b6004837fc9435909000000000000000000000000000000000000000000000000000000008152fd5b602483837f9fb0d64c000000000000000000000000000000000000000000000000000000008252600452fd5b508060031936011261024457806001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016803b156105a35781602491604051928380927fb760faf900000000000000000000000000000000000000000000000000000000825230600483015234905af18015610598576105875750f35b8161059191611a30565b6102445780f35b6040513d84823e3d90fd5b50fd5b503461024457806003193601126102445760206001600160a01b0360055416604051908152f35b5034610244578060031936011261024457604051906370a0823160e01b82523060048301526020826024816001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000165afa908115610673579061063c575b602090604051908152f35b506020813d60201161066b575b8161065660209383611a30565b810103126106675760209051610631565b5f80fd5b3d9150610649565b604051903d90823e3d90fd5b5034610244578060031936011261024457604060035460ff82519165ffffffffffff8116835260301c166020820152f35b503461024457602036600319011261024457806106cb611993565b6106d3611fb4565b6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001690813b15610752576001600160a01b03602484928360405195869485937fc23a5cea0000000000000000000000000000000000000000000000000000000085521660048401525af18015610598576105875750f35b5050fd5b503461024457806003193601126102445760206001600160a01b0360025416604051908152f35b503461024457604036600319011261024457610797611993565b6001600160a01b036107a76119a9565b916107b0611fb4565b1690818352600960205260ff604084205460301c16156108335765ffffffffffff16621e848081116108245760207f35e459692f13ac64112f3d2d121ddd0f90cfe52d8f3f900ee48b279c774b701f9183855260098252604085208165ffffffffffff19825416179055604051908152a280f35b600483631211a89f60e21b8152fd5b602483836306439c6b60e01b8252600452fd5b503461024457806003193601126102445761085f611fb4565b806001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016803b156105a3578180916004604051809481937fbb9fe6bf0000000000000000000000000000000000000000000000000000000083525af18015610598576105875750f35b50346102445760c03660031901126102445760043567ffffffffffffffff81116104015761012060031982360301126104015761090a6119a9565b60443565ffffffffffff8116810361096457606435916001600160a01b03831683036109605760a4359465ffffffffffff861686036102445760206109588760843587878760048c01611b0f565b604051908152f35b8480fd5b8380fd5b503461024457806003193601126102445760206040516001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000168152f35b50346102445780600319360112610244576020600654604051908152f35b503461024457806003193601126102445760206001600160a01b0360015416604051908152f35b503461024457604036600319011261024457610a0b611fb4565b604051610a1781611a00565b60043565ffffffffffff81168103610a4a5781526024359060ff82168203610a4a57610a4791602082015261211f565b80f35b8280fd5b50346102445780600319360112610244576020638b78c6d819546001600160a01b0360405191168152f35b50346102445760203660031901126102445760ff60406020926001600160a01b03610aa2611993565b1681528084522054166040519015158152f35b50346102445760403660031901126102445760043567ffffffffffffffff8111610401573660238201121561040157806004013567ffffffffffffffff8111610a4a576024820191602436918360051b010111610a4a576024359081151580920361096457610b22611fb4565b60ff821692845b828110610b34578580f35b806001600160a01b03610b52610b4d6001948787611a6e565b611a92565b1687526007602052604087208660ff198254161790557f8ff8c5211f68ef53b4bdd15ab2ea6d87be8a3dbf58865bd8325c984057e4fcb46040610b99610b4d848888611a6e565b6001600160a01b03825191168152876020820152a101610b29565b503461024457608036600319011261024457600360043510156102445760243567ffffffffffffffff811161040157610bf4610a479136906004016119d2565b90610bfd61222e565b6064359160443591612b46565b5034610244576020366003190112610244576001600160a01b03610c2c611993565b610c34611fb4565b16808252600960205260ff604083205460301c1615610c9057808252600960205281604081205580825260046020528160408120557f4c910b69fe65a61f7531b9c5042b2329ca7179c77290aa7e2eb3afa3c8511fd38280a280f35b6306439c6b60e01b8252600452602490fd5b50346102445760203660031901126102445760ff60406020926001600160a01b03610ccb611993565b16815260098452205460301c166040519015158152f35b50602036600319011261024457600435610cfa611fb4565b620249f08111610d3e5760407f33ddf610723ec48e858790576fb3294cc312fcbd937c1475d53e3673145488eb91600654908060065582519182526020820152a180f35b6004827f627b654a000000000000000000000000000000000000000000000000000000008152fd5b508060031936011261024457600490610d7d611fb4565b7f0e98a7a2000000000000000000000000000000000000000000000000000000008152fd5b506020366003190112610244576001600160a01b03610dbf611993565b610dc7611fb4565b168015610e1e576001600160a01b036005548273ffffffffffffffffffffffffffffffffffffffff19821617600555167fccde24da5797c4d64f7ad2aedd15db412e2d301f426be8da35b1e251321eec6e8380a380f35b6004827fa295f1bc000000000000000000000000000000000000000000000000000000008152fd5b50806003193601126102445763389a75e1600c52338152806020600c2055337ffa7b8eab7da67f412cc9575ed43464468f9bfbae89d1675917346ca6d8fe3c928280a280f35b50346102445760203660031901126102445760043567ffffffffffffffff811161040157610ebe9036906004016119d2565b91610ec98383612aac565b9390916002811015610fb657610fa75784602411610a4a57601481013594603411610a4a576024013592610efc91612ae3565b969597928795999291946040519a65ffffffffffff8c9b168b5265ffffffffffff1660208b01526001600160a01b031660408a0152606089015265ffffffffffff16608088015260801c6fffffffffffffffffffffffffffffffff1660a087015260801c6fffffffffffffffffffffffffffffffff1660c086015260e085016101009052816101008601526101208501378183016101200152601f1990601f01168101036101200190f35b60048363817c70e760e01b8152fd5b602484634e487b7160e01b81526021600452fd5b50346102445760603660031901126102445760043567ffffffffffffffff811161040157610120600319823603011261040157602061101960609261100d61222e565b604435906004016122cb565b604092919251948593604085528051938491826040880152018686015e8383018501526020830152601f01601f19168101030190f35b5034610244578060031936011261024457602060ff600854166040519015158152f35b5034610244576060366003190112610244576004356001600160a01b03811680910361040157602435906001600160a01b0382169081830361096457604435926110ba611fb4565b6110c26121ba565b821561116f57601452826034526fa9059cbb00000000000000000000000084526020846044601082855af18060018651141615611151575b50836034526040519283527fedf7bea45e16025d7f82902171a24376f5f3a2c06d9d8c2be4d41bbc7292f74a60203394a4807f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f005d80f35b3d823b15171015611162575f6110fa565b6390b8ec1884526004601cfd5b600485634261081360e11b8152fd5b50346102445760203660031901126102445760ff60406020926001600160a01b036111a7611993565b168152600784522054166040519015158152f35b50806003193601126102445763389a75e1600c523381526202a30042016020600c2055337fdbf36a107da19e49527a7176a1babf963b4b0ff8cde35ee35d6cd8f1f9ac7e1d8280a280f35b503461024457608036600319011261024457611220611993565b6112286119a9565b906040366043190112610a4a5761123d611fb4565b60405161124981611a00565b6044356001600160a01b038116810361096057815260643565ffffffffffff811681036109605760208201526001600160a01b0382169283156113a65765ffffffffffff1691621e8480831161139757838552600960205260ff604086205460301c1661136f579161136b826113406060947f064ffbbbb47c17889eb51257d47e705f5f589c62458218b8322978262bb89e8496898965ffffffffffff8060408051946112f586611a00565b8b865260208601946001865281526009602052209351161665ffffffffffff1983541617825551151566ff00000000000082549160301b169066ff0000000000001916179055611fd0565b604051928352602083019065ffffffffffff602080926001600160a01b038151168552015116910152565ba280f35b6004857fc78e82ad000000000000000000000000000000000000000000000000000000008152fd5b600485631211a89f60e21b8152fd5b6004857f1eb00b06000000000000000000000000000000000000000000000000000000008152fd5b503461024457604036600319011261024457806113e9611993565b6113f1611fb4565b6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001690813b15610752576001600160a01b03604484928360405195869485937f205c287800000000000000000000000000000000000000000000000000000000855216600484015260243560248401525af18015610598576105875750f35b503461024457602036600319011261024457604080916001600160a01b0361149e611993565b82602085516114ac81611a00565b828152015216815260046020522065ffffffffffff8251916114cd83611a00565b546001600160a01b038116835260a01c16602082015261150a8251809265ffffffffffff602080926001600160a01b038151168552015116910152565bf35b50604036600319011261024457611521611993565b6001600160a01b0360243591611535611fb4565b61153d6121ba565b1680156115f0578280808085855af13d156115eb573d61155c81611a52565b9061156a6040519283611a30565b81528460203d92013e5b156115c3577f8455ae6be5d92f1df1c3c1484388e247a36c7e60d72055ae216dbc258f257d4b8380a3807f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f005d80f35b6004837f27fcd9d1000000000000000000000000000000000000000000000000000000008152fd5b611574565b600483634261081360e11b8152fd5b506020366003190112610244576001600160a01b0361161c611993565b611624611fb4565b168082528160205260ff6040832054161561167357808252816020526040822060ff1981541690557f3525e22824a8a7df2c9a6029941c824cf95b6447f1e13d5128fd3826d35afe8b8280a280f35b7f2ac468fb000000000000000000000000000000000000000000000000000000008252600452602490fd5b503461024457602036600319011261024457604080916001600160a01b036116c4611993565b1681526004602052205465ffffffffffff8251916001600160a01b038116835260a01c166020820152f35b5060203660031901126106675760043563ffffffff811680910361066757611715611fb4565b6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001690813b15610667575f906024604051809481937f0396cb60000000000000000000000000000000000000000000000000000000008352600483015234905af1801561179a5761178c575080f35b61179891505f90611a30565b005b6040513d5f823e3d90fd5b34610667576060366003190112610667576117be611993565b6117c66119a9565b6044359160ff8316809303610667576001600160a01b03906117e6611fb4565b16918273ffffffffffffffffffffffffffffffffffffffff19600154161760015560405163313ce56760e01b8152602081600481875afa90811561179a57611798947f8fc6315ba94359fb67e8182b2c063eeb20ced644701b057dce2d628ee0c8f890926020925f916118c2575b507fffffffffffffffffffffff00ffffffffffffffffffffffffffffffffffffffff74ff00000000000000000000000000000000000000006002549260a01b16911617600255604051908152a165ffffffffffff604051926118b584611a00565b168252602082015261211f565b6118e29150833d85116118e8575b6118da8183611a30565b810190611c15565b87611854565b503d6118d0565b3461066757606036600319011261066757611908611993565b60403660231901126106675761191c611fb4565b6001600160a01b038116805f52600960205260ff60405f205460301c1615611981575060405161194b81611a00565b6024356001600160a01b03811681036106675781526044359165ffffffffffff8316830361066757611798926020830152611fd0565b6306439c6b60e01b5f5260045260245ffd5b600435906001600160a01b038216820361066757565b6024359065ffffffffffff8216820361066757565b35906001600160a01b038216820361066757565b9181601f840112156106675782359167ffffffffffffffff8311610667576020838186019501011161066757565b6040810190811067ffffffffffffffff821117611a1c57604052565b634e487b7160e01b5f52604160045260245ffd5b90601f8019910116810190811067ffffffffffffffff821117611a1c57604052565b67ffffffffffffffff8111611a1c57601f01601f191660200190565b9190811015611a7e5760051b0190565b634e487b7160e01b5f52603260045260245ffd5b356001600160a01b03811681036106675790565b903590601e1981360301821215610667570180359067ffffffffffffffff82116106675760200191813603831361066757565b929192611ae582611a52565b91611af36040519384611a30565b829481845281830111610667578281602093845f960137010152565b939194929094611b2c611b256040870187611aa6565b3691611ad9565b6020815191012095611b44611b256060880188611aa6565b6020815191012095611b5960e0820182611aa6565b603411610667576014013560405197602089019983356001600160a01b03168b52602084013560408b015260608a01526080890152608082013560a089015260c088015260a081013560e088015260c00135610100870152466101208701523061014087015265ffffffffffff1661016086015265ffffffffffff166101808501526001600160a01b03166101a08401526101c083015265ffffffffffff166101e08201526101e08152611c0f61020082611a30565b51902090565b90816020910312610667575160ff811681036106675790565b519069ffffffffffffffffffff8216820361066757565b908160a091031261066757611c5981611c2e565b91602082015191604081015191611c77608060608401519301611c2e565b90565b91908201809211611c8757565b634e487b7160e01b5f52601160045260245ffd5b9060ff8091169116039060ff8211611c8757565b60ff16604d8111611c8757600a0a90565b81810292918115918404141715611c8757565b8115611cdd570490565b634e487b7160e01b5f52601260045260245ffd5b6001600160a01b03165f8181526004602052604080822090519190611d1583611a00565b54926001600160a01b03841680845265ffffffffffff602085019560a01c16855215611f895760049060206001600160a01b038551166040519384809263313ce56760e01b82525afa91821561179a575f92611f68575b50600254946001600160a01b03861680611ec6575b50611da49065ffffffffffff6001600160a01b0360049697511691511690612d91565b81929193611dc86001600160a01b036001541665ffffffffffff6003541690612d91565b819381811080611ebd575b15611ea25760ff9150995b60a01c169460ff831686811115611e6c5750505090611e0b611e0660209495611e1194611c9b565b611caf565b90611cc0565b915b6040519485809263313ce56760e01b82525afa90811561179a57611e0b611e4592611e4a955f91611e4d575b50611caf565b611cd3565b92565b611e66915060203d6020116118e8576118da8183611a30565b5f611e3f565b86929691945010611e83575b505050602090611e13565b6020939550611e06611e999392611e0b92611c9b565b92905f80611e78565b508015611eb25760ff9099611dde565b5060ff600199611dde565b50801515611dd3565b600491945060a09060405192838092633fabe5a360e21b82525afa90811561179a575f905f92611f33575b50611f0b57610e108101809111611c875792611da4611d81565b7f032b3d00000000000000000000000000000000000000000000000000000000005f5260045ffd5b9050611f57915060a03d60a011611f61575b611f4f8183611a30565b810190611c45565b505091505f611ef1565b503d611f45565b611f8291925060203d6020116118e8576118da8183611a30565b905f611d6c565b7f8a48ce38000000000000000000000000000000000000000000000000000000005f5260045260245ffd5b638b78c6d819543303611fc357565b6382b429005f526004601cfd5b906001600160a01b03815116156120f757602081019165ffffffffffff83511680159081156120ea575b506120c3577f24e1353e7ce7278b88d4d6dcfc29992d0e138c0ab47d793b173bb8318fe99e24916001600160a01b036040921693845f526004602052825f20906001600160a01b0383511673ffffffffffffffffffffffffffffffffffffffff19835416178255517fffffffffffff000000000000ffffffffffffffffffffffffffffffffffffffff65ffffffffffff60a01b83549260a01b1691161790556120c08251809265ffffffffffff602080926001600160a01b038151168552015116910152565ba2565b7eacf6ab000000000000000000000000000000000000000000000000000000005f5260045ffd5b6202a3009150115f611ffa565b7f55210681000000000000000000000000000000000000000000000000000000005f5260045ffd5b65ffffffffffff81511680159081156121ad575b506120c35760408160ff602065ffffffffffff7f93763050325d1d84aaf84b5fe9bff2caf268131a8384844c169b2cadad99b1de955116928365ffffffffffff19600354161760035501805166ff0000000000006003549160301b169066ff000000000000191617600355835192835251166020820152a1565b6202a3009150115f612133565b7f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f005c6122065760017f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f005d565b7f3ee5aeb5000000000000000000000000000000000000000000000000000000005f5260045ffd5b6001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016330361226057565b60646040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601860248201527f43616c6c6572206973206e6f7420456e747279506f696e7400000000000000006044820152fd5b91908203918211611c8757565b919060609260e08101906122e86122e28383611aa6565b90612aac565b969091946002861015612a9857600160ff871611612a89576006549261230d85612e31565b8411612a61576001600160a01b03853516926080860135966123406123398960801c60a08a0135611c7a565b9188611aa6565b6024116106675761237e9161235c916014013560801c90611c7a565b976fffffffffffffffffffffffffffffffff61237789612e31565b9116611c7a565b976001810361268a57505060ff600854161580612673575b612647576014891061261f5788601411610667573560601c97601319016125f757875f52600960205260ff60405f205460301c16156125e45761240f9261241561241a928a5f52600960205265ffffffffffff60405f2054169586936fffffffffffffffffffffffffffffffff60c08a01351690611cc0565b90611c7a565b611cc0565b94620f4240860195868111611c8757620f423f01958611611c875761243e88611cf1565b929193909784156125b85784620f42406124589204611cc0565b61246e60ff60035460301c169161240f83611caf565b5f198101908111611c875761248f6020916124898e94611caf565b90611cd3565b926024604051809481936370a0823160e01b835260048301525afa90811561179a575f91612586575b501061255e5765ffffffffffff60a01b9561254179ffffffffffffffffffffffffffffffffffffffffffffffffffff1995869561254f946124f98b9a611a92565b946040519e8f966020880194909695919365ffffffffffff936001600160a01b0360a0968160c08a019b16895216602088015260408701526060860152608085015216910152565b03601f1981018a5289611a30565b60d01b16169260a01b16161790565b7fb223be11000000000000000000000000000000000000000000000000000000005f5260045ffd5b90506020813d6020116125b0575b816125a160209383611a30565b8101031261066757515f6124b8565b3d9150612594565b8a7fccffa451000000000000000000000000000000000000000000000000000000005f5260045260245ffd5b876306439c6b60e01b5f5260045260245ffd5b7f9f8bc10c000000000000000000000000000000000000000000000000000000005f5260045ffd5b7f25d8dfa4000000000000000000000000000000000000000000000000000000005f5260045ffd5b7f55d3ab46000000000000000000000000000000000000000000000000000000005f523260045260245ffd5b50325f52600760205260ff60405f20541615612396565b5f9a919394989796959a50156126a95763817c70e760e01b5f5260045ffd5b6126b291612ae3565b9296939b919790949d8715612a2c57604084141580612a21575b6129f95765ffffffffffff891690621e848082116129ea5761270c9261240f612415926fffffffffffffffffffffffffffffffff60c08f01351690611cc0565b620f4240810190818111611c8757620f423f01908111611c875786620f42406127359204611cc0565b61274b60ff60035460301c169161240f83611caf565b5f198101908111611c87578c60246127706020936124896001600160a01b0396611caf565b9460405194859384926370a0823160e01b84526004840152165afa90811561179a575f916129b8575b501061255e576127e96001600160a01b03936127ba888f8e8a918a8e611b0f565b6020527b19457468657265756d205369676e6564204d6573736167653a0a33325f52603c600420923691611ad9565b915f9260405192602082019180518060401461297a576041146129445750505050505b16801561291c575f525f60205260ff60405f2054161598895f146128ed5760ff65ffffffffffff60a01b79ffffffffffffffffffffffffffffffffffffffffffffffffffff196001935b60d01b169360a01b1691161717976128d2576128ce946128786128c094611a92565b946040519788966020880194909695919365ffffffffffff936001600160a01b0360a0968160c08a019b16895216602088015260408701526060860152608085015216910152565b03601f198101835282611a30565b9190565b5050505050506040516128e6602082611a30565b5f81529190565b60ff65ffffffffffff60a01b79ffffffffffffffffffffffffffffffffffffffffffffffffffff195f93612856565b7f11ec9984000000000000000000000000000000000000000000000000000000005f5260045ffd5b808401515f1a60205260400151835292935090915b5f52516040526020604060805f60015afa505f81523d18519060405261280c565b507f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff91929394955060400151601b8160ff1c01602052168352612959565b90506020813d6020116129e2575b816129d360209383611a30565b8101031261066757515f612799565b3d91506129c6565b631211a89f60e21b5f5260045ffd5b7ff95eeeac000000000000000000000000000000000000000000000000000000005f5260045ffd5b5060418414156126cc565b6001600160a01b038d7fb420c372000000000000000000000000000000000000000000000000000000005f521660045260245ffd5b7f0359a00f000000000000000000000000000000000000000000000000000000005f5260045ffd5b63817c70e760e01b5f5260045ffd5b634e487b7160e01b5f52602160045260245ffd5b916035821061261f578160341015611a7e57603483013560f81c6002811015612a9857928260351161066757603501916034190190565b906046811061261f578060061161066757813560d01c92600c821061066757600683013560d01c926020831061066757600c81013560601c9260408110610667576020820135928160461161066757604083013560d01c92604601916045190190565b908160c0919493948101031261066757612b5f816119be565b90612b6c602082016119be565b9260408201359460608301359160a060808501359401359265ffffffffffff84168403610667576001600160a01b03808716971697612bab8385611cd3565b905f906006548382612bbe838097611c7a565b11612d75575b5050505f92818111612d3f575b50509261240f65ffffffffffff93612415612bef94612bf897611c7a565b92168092611cc0565b620f4240810190818111611c8757620f423f01908111611c875782620f4240612c219204611cc0565b612c3760ff60035460301c169161240f83611caf565b5f198101908111611c8757612489612c4e92611caf565b928315612d37576001600160a01b03600554169060405191856060526040526bffffffffffffffffffffffff199060601b16602c526f23b872dd000000000000000000000000600c5260205f6064601c828a5af1908160015f51141615612d2a575b5f60605260405215612cf557916060917f652a3e2ecdaeb77e89486cb74be65c4579b831f00b22f6176aca49f3893827fd9360405192835260208301526040820152a3565b505092507fbc7b62d8000000000000000000000000000000000000000000000000000000005f5260045260245260445260645ffd5b903d873b15171090612cb0565b505050505050565b612d4b929593506122be565b90600a820291808304600a1490151715611c87579260649091049061240f65ffffffffffff612bd1565b612d89935090612d8491611c7a565b6122be565b5f8281612bc4565b9060a06001600160a01b0392600460405180958193633fabe5a360e21b8352165afa801561179a575f925f91612e09575b505f831315612de15765ffffffffffff612ddd921690611c7a565b9091565b7fa97b994d000000000000000000000000000000000000000000000000000000005f5260045ffd5b9050612e2591925060a03d60a011611f6157611f4f8183611a30565b5093925050915f612dc2565b612e3f9060e0810190611aa6565b603411610667576024013560801c9056fea264697066735822122098f9f60ea31f1f9b05d552bf26cc735ab4eb428e1c78a947d41241c3792db11164736f6c634300081e0033";

        // Load environment variables
        // uint256 salt = vm.envUint("SALT");
        address owner = vm.envAddress("OWNER");
        address feeTreasury = vm.envAddress("TOKEN_FEE_TREASURY");
        uint256 unaccountedGas = vm.envUint("TOKEN_PM_UNACCOUNTED_GAS");
        address nativeAssetToUsdOracle = vm.envAddress("NATIVE_ASSET_TO_USD_ORACLE_SONEIUM_MAINNET");
        address sequencerUptimeOracle = vm.envAddress("SEQUENCER_UPTIME_ORACLE_SONEIUM_MAINNET");
        uint48 nativeAssetMaxOracleRoundAge = uint48(vm.envUint("NATIVE_ASSET_MAX_ORACLE_ROUND_AGE"));
        uint8 nativeAssetDecimals = 18;

        // Let's deploy with one Independent Token and more we can add later
        address astrAddress = vm.envAddress("ASTR_TOKEN_ADDERESS_SONEIUM_MAINNET");
        address astrToUsdOracle = vm.envAddress("ASTR_TO_USD_ORACLE_SONEIUM_MAINNET");
        uint48 feeMarkupForIndependentToken = uint48(vm.envUint("FEE_MARKUP_FOR_INDEPENDENT_TOKEN"));
        uint48 astrMaxOracleRoundAge = uint48(vm.envUint("ASTR_MAX_ORACLE_ROUND_AGE"));

        // Parse signers from comma-separated string
        string[] memory signers = vm.envString("SIGNERS", ",");
        address[] memory signersAddr = new address[](signers.length);
        for (uint256 i = 0; i < signers.length; i++) {
            signersAddr[i] = vm.parseAddress(signers[i]);
        }

        bytes memory constructorArgs = abi.encode(
            owner,
            entryPoint,
            signersAddr,
            feeTreasury,
            unaccountedGas,
            nativeAssetToUsdOracle,
            sequencerUptimeOracle,
            nativeAssetMaxOracleRoundAge,
            nativeAssetDecimals,
            _toSingletonArray(astrAddress),
            _toSingletonArray(feeMarkupForIndependentToken),
            _toSingletonArray(
                IOracleHelper.TokenOracleConfig({
                    tokenOracle: IOracle(address(astrToUsdOracle)),
                    maxOracleRoundAge: astrMaxOracleRoundAge
                })
            )
        );

        // Concatenate bytecode + constructor arguments
        bytes memory finalBytecode = abi.encodePacked(deployedBytecode, constructorArgs);

        // Deploy contract if needed
        deployGeneric(deployerPrivateKey, saltString, finalBytecode, contractName);
    }

    function deployGeneric(
        uint256 deployerPrivateKey,
        string memory saltString,
        bytes memory finalBytecode,
        string memory contractName
    ) public {
        // Compute derived salt
        bytes32 derivedSalt = keccak256(abi.encodePacked(saltString));

        // Compute contract address before deployment
        address computedAddress = deployerInstance.addressOf(derivedSalt);

        console.log(string(abi.encodePacked(contractName, " Computed Address:")), computedAddress);

        // Check if contract is already deployed
        uint256 codeSize;
        assembly {
            codeSize := extcodesize(computedAddress)
        }

        if (codeSize == 0) {
            console.log(string(abi.encodePacked(contractName, " not deployed, deploying now...")));
            deployContract(deployerPrivateKey, derivedSalt, finalBytecode, contractName, computedAddress);
        } else {
            console.log(string(abi.encodePacked(contractName, " already deployed at:")), computedAddress);
        }
    }

    function deployContract(
        uint256 deployerPrivateKey,
        bytes32 derivedSalt,
        bytes memory finalBytecode,
        string memory contractName,
        address computedAddress
    ) internal {
        uint256 chainId = block.chainid;

        uint256 gasPrice = DEPLOYMENT_CHAIN_GAS_PRICES[chainId];
        require(gasPrice > 0, "No deployment gas price set for this chain");

        console.log("Using gas price:", gasPrice);

        // Deploy contract using deployer's private key
        vm.startBroadcast(deployerPrivateKey);
        (bool success,) = address(deployerInstance).call{gas: 5_000_000}(
            abi.encodeWithSignature("deploy(bytes32,bytes)", derivedSalt, finalBytecode)
        );
        vm.stopBroadcast();

        require(success, "Contract deployment failed");

        console.log(string(abi.encodePacked("Transaction success: ", contractName)));

        // Verify deployment by checking contract existence
        uint256 codeSize;
        assembly {
            codeSize := extcodesize(computedAddress)
        }

        if (codeSize == 0) {
            console.log(string(abi.encodePacked("Invalid deployment of ", contractName)));
        } else {
            console.log(string(abi.encodePacked(contractName, " Deployed Successfully at:")), computedAddress);
        }
    }

    function _toSingletonArray(address addr) internal pure returns (address[] memory) {
        address[] memory array = new address[](1);
        array[0] = addr;
        return array;
    }

    function _toSingletonArray(uint48 element) internal pure returns (uint48[] memory) {
        uint48[] memory array = new uint48[](1);
        array[0] = element;
        return array;
    }

    function _toSingletonArray(IOracleHelper.TokenOracleConfig memory tokenOracleConfig)
        internal
        pure
        returns (IOracleHelper.TokenOracleConfig[] memory)
    {
        IOracleHelper.TokenOracleConfig[] memory array = new IOracleHelper.TokenOracleConfig[](1);
        array[0] = tokenOracleConfig;
        return array;
    }
}
